{"version":3,"sources":["../../src/cache/cache.middleware.ts"],"sourcesContent":["import { Injectable, NestMiddleware } from \"@nestjs/common\";\nimport { Request, Response, NextFunction } from \"express\";\nimport { CacheService } from \"./cache.service\";\nimport { CacheData } from \"./dto/cache-data.dto\";\n\n@Injectable()\nexport class CacheMiddleware implements NestMiddleware {\n    constructor(private readonly cacheService: CacheService) {}\n\n    async use(req: Request, res: Response, next: NextFunction) {\n        const key: string = this.cacheService.reqToKey(req);\n\n        const cacheData: null | CacheData = await this.cacheService.readCache(key);\n\n        if (cacheData !== null && cacheData !== undefined) {\n            try {\n                res.status(cacheData.statusCode).set(cacheData.headers);\n                return res.send(cacheData.data);\n            } catch (error) {\n                console.error(error);\n            }\n        } else {\n            const oldSend = res.send;\n\n            res.send = (dataForCache: string) => {\n                // set the function back to avoid the 'double-send' effect\n                res.send = oldSend;\n\n                // cache the response only if it is successful\n                if (res.statusCode.toString().startsWith(\"2\")) {\n                    this.cacheService.writeCache(key, new CacheData(res.statusCode, res.getHeaders(), dataForCache));\n                }\n                return res.send(dataForCache);\n            };\n        }\n\n        next();\n    }\n}\n"],"names":["CacheMiddleware","use","req","res","next","key","cacheService","reqToKey","cacheData","readCache","undefined","status","statusCode","set","headers","send","data","error","console","oldSend","dataForCache","toString","startsWith","writeCache","CacheData","getHeaders","constructor"],"mappings":";;;;+BAMaA;;;eAAAA;;;wBAN8B;8BAEd;8BACH;;;;;;;;;;AAGnB,IAAA,AAAMA,kBAAN,MAAMA;IAGT,MAAMC,IAAIC,GAAY,EAAEC,GAAa,EAAEC,IAAkB,EAAE;QACvD,MAAMC,MAAc,IAAI,CAACC,YAAY,CAACC,QAAQ,CAACL;QAE/C,MAAMM,YAA8B,MAAM,IAAI,CAACF,YAAY,CAACG,SAAS,CAACJ;QAEtE,IAAIG,cAAc,QAAQA,cAAcE,WAAW;YAC/C,IAAI;gBACAP,IAAIQ,MAAM,CAACH,UAAUI,UAAU,EAAEC,GAAG,CAACL,UAAUM,OAAO;gBACtD,OAAOX,IAAIY,IAAI,CAACP,UAAUQ,IAAI;YAClC,EAAE,OAAOC,OAAO;gBACZC,QAAQD,KAAK,CAACA;YAClB;QACJ,OAAO;YACH,MAAME,UAAUhB,IAAIY,IAAI;YAExBZ,IAAIY,IAAI,GAAG,CAACK;gBACR,0DAA0D;gBAC1DjB,IAAIY,IAAI,GAAGI;gBAEX,8CAA8C;gBAC9C,IAAIhB,IAAIS,UAAU,CAACS,QAAQ,GAAGC,UAAU,CAAC,MAAM;oBAC3C,IAAI,CAAChB,YAAY,CAACiB,UAAU,CAAClB,KAAK,IAAImB,uBAAS,CAACrB,IAAIS,UAAU,EAAET,IAAIsB,UAAU,IAAIL;gBACtF;gBACA,OAAOjB,IAAIY,IAAI,CAACK;YACpB;QACJ;QAEAhB;IACJ;IA9BAsB,YAAY,AAAiBpB,YAA0B,CAAE;aAA5BA,eAAAA;IAA6B;AA+B9D"}